{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "My Data" %} - Nobodies Profiles{% endblock %}

{% block content %}
<div class="container">
    <h1>{% trans "My Data" %}</h1>
    <p class="lead">{% trans "Manage your personal data in accordance with GDPR." %}</p>

    {% if profile %}
    <div class="row">
        <!-- Data Export Section -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h2 class="h5 mb-0">{% trans "Data Export" %}</h2>
                </div>
                <div class="card-body">
                    <p>{% trans "Download a copy of all your personal data stored in our system." %}</p>

                    {% if can_request_export %}
                    <a href="{% url 'gdpr:request_export' %}" class="btn btn-primary">
                        {% trans "Request Data Export" %}
                    </a>
                    {% else %}
                    <p class="text-muted">
                        {% blocktrans with hours=export_rate_limit_hours %}
                        You can request a new export every {{ hours }} hours.
                        {% endblocktrans %}
                    </p>
                    {% endif %}

                    {% if export_requests %}
                    <hr>
                    <h3 class="h6">{% trans "Recent Exports" %}</h3>
                    <ul class="list-unstyled">
                        {% for req in export_requests %}
                        <li class="mb-2">
                            <span class="badge
                                {% if req.status == 'COMPLETED' %}bg-success
                                {% elif req.status == 'PROCESSING' %}bg-info
                                {% elif req.status == 'FAILED' %}bg-danger
                                {% elif req.status == 'EXPIRED' %}bg-secondary
                                {% else %}bg-warning{% endif %}">
                                {{ req.get_status_display }}
                            </span>
                            {{ req.created_at|date:"M j, Y H:i" }}
                            {% if req.is_downloadable %}
                            <a href="{% url 'gdpr:download_export' req.download_token %}" class="btn btn-sm btn-outline-primary">
                                {% trans "Download" %}
                            </a>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Account Deletion Section -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-danger text-white">
                    <h2 class="h5 mb-0">{% trans "Account Deletion" %}</h2>
                </div>
                <div class="card-body">
                    <p>{% trans "Request permanent deletion of your account and all associated data." %}</p>

                    {% if deletion_request %}
                    <div class="alert alert-warning">
                        <strong>{% trans "Pending Request" %}</strong><br>
                        {% trans "Status:" %} {{ deletion_request.get_status_display }}<br>
                        {% trans "Requested:" %} {{ deletion_request.created_at|date:"M j, Y H:i" }}
                        {% if deletion_request.status == 'PENDING_CONFIRMATION' %}
                        <br><small>{% trans "Please check your email to confirm the request." %}</small>
                        {% endif %}
                    </div>
                    {% else %}
                    <a href="{% url 'gdpr:request_deletion' %}" class="btn btn-outline-danger">
                        {% trans "Request Account Deletion" %}
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Data Summary -->
    <div class="card mt-4">
        <div class="card-header">
            <h2 class="h5 mb-0">{% trans "Your Data Summary" %}</h2>
        </div>
        <div class="card-body">
            <p>{% trans "Here is a summary of the personal data we store about you:" %}</p>
            <ul>
                <li><strong>{% trans "Profile Information:" %}</strong> {% trans "Name, country, membership status" %}</li>
                <li><strong>{% trans "Account Information:" %}</strong> {% trans "Email, display name, language preference" %}</li>
                <li><strong>{% trans "Membership History:" %}</strong> {% trans "Role assignments, team memberships" %}</li>
                <li><strong>{% trans "Consent Records:" %}</strong> {% trans "Documents you have agreed to" %}</li>
                <li><strong>{% trans "Activity Logs:" %}</strong> {% trans "Login history, system access" %}</li>
            </ul>
        </div>
    </div>

    {% else %}
    <div class="alert alert-info">
        {% trans "You don't have a profile yet. GDPR data management will be available once you have an active membership." %}
    </div>
    {% endif %}

    <!-- Help Section -->
    <div class="card mt-4">
        <details>
            <summary style="cursor: pointer; font-weight: bold; padding: 15px;">{% trans "Understanding Your GDPR Rights" %}</summary>
            <div class="card-body pt-0">
                <h3 class="h5">{% trans "What is GDPR?" %}</h3>
                <p>{% trans "GDPR (General Data Protection Regulation) is a European law that gives you control over your personal data. As a member, you have specific rights:" %}</p>

                <dl>
                    <dt>{% trans "Right of Access (Article 15)" %}</dt>
                    <dd>{% trans "You can request a copy of all personal data we store about you. The system generates a ZIP file containing everything in a readable format. You can request this once every 24 hours." %}</dd>

                    <dt>{% trans "Right to Erasure (Article 17)" %}</dt>
                    <dd>{% trans "You can request deletion of your account and personal data. This goes through board review to ensure proper handoff of any responsibilities. Once approved, your data is anonymized (not fully deleted, as we must keep some records for legal compliance)." %}</dd>

                    <dt>{% trans "Right to Rectification (Article 16)" %}</dt>
                    <dd>{% trans "You can update your information anytime through your profile page. For changes to your legal name, contact the Board." %}</dd>
                </dl>

                <h3 class="h5 mt-4">{% trans "Common Questions" %}</h3>
                <dl>
                    <dt>{% trans "What happens to my data export?" %}</dt>
                    <dd>{% blocktrans with days=30 %}The export file is available for download for {{ days }} days, then automatically deleted from our servers for security.{% endblocktrans %}</dd>

                    <dt>{% trans "Why does deletion require board review?" %}</dt>
                    <dd>{% trans "To ensure any shared resources you manage are properly transferred and to verify your identity. This protects both you and the organization." %}</dd>

                    <dt>{% trans "What data is kept after deletion?" %}</dt>
                    <dd>{% trans "Only anonymized consent records (required by Spanish law to prove you agreed to documents). All personally identifiable information is removed." %}</dd>

                    <dt>{% trans "Can I rejoin after deletion?" %}</dt>
                    <dd>{% trans "Yes, but you would need to create a new account and go through the application process again." %}</dd>
                </dl>

                <p class="text-muted mt-3">
                    {% trans "Questions about your data rights? Contact" %} <a href="mailto:board@nobodies.team">board@nobodies.team</a>
                </p>
            </div>
        </details>
    </div>

    <div class="actions mt-4">
        <a href="{% url 'dashboard' %}" class="btn btn-secondary">{% trans "Back to Dashboard" %}</a>
    </div>
</div>
{% endblock %}
